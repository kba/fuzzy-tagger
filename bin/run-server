#!/usr/bin/env coffee

CSON = require 'cson'
Async = require 'async'
Fs = require 'fs'
Path = require 'path'
TaggingServer = require '../src/TaggingServer'
Nedb = require 'nedb'

taglist = CSON.load 'data/tags.cson'

files = {}
basedir = Path.resolve(process.env.TAGDIR or '.')
for filename in Fs.readdirSync(basedir)
	continue unless /(png|jpg|gif)$/.test(filename)
	files[basedir + '/' + filename] = {"tags": ['foo']}

filenames = Object.keys(files)
for i in [0 ... filenames.length]
	files[filenames[i]].prev = filenames[i - 1] || null
	files[filenames[i]].next = filenames[i + 1] || null

db = new Nedb(filename: 'db.json')
db.loadDatabase (err) ->
	Async.each Object.keys(files), (filename, cb) ->
		files[filename]._id = filename
		db.insert files[filename], cb
	, (err) ->
		srv = new TaggingServer(files, taglist, db)
		srv.listen 3000

# vim: ft=coffee :
